# download.versatiles.org

[![Code Coverage](https://codecov.io/gh/versatiles-org/download.versatiles.org/branch/main/graph/badge.svg?token=IDHAI13M0K)](https://codecov.io/gh/versatiles-org/download.versatiles.org)
[![GitHub Workflow Status)](https://img.shields.io/github/actions/workflow/status/versatiles-org/download.versatiles.org/ci.yml)](https://github.com/versatiles-org/download.versatiles.org/actions/workflows/ci.yml)

## Project Outline

This repository contains the complete static‑site update pipeline and NGINX configuration
that power **https://download.versatiles.org** — the public distribution endpoint for
VersaTiles datasets.

The updater performs all file‑management tasks required for the site, but **does not act as
a web server in production**. Its responsibilities include:

- scanning remote `.versatiles` files stored on external/remote storage  
- generating or updating `.md5` and `.sha256` checksum files  
- grouping files into datasets and identifying the latest version  
- copying selected datasets into the local high‑speed storage  
- generating the frontend output (`index.html` and per‑dataset RSS feeds)  
- producing the complete NGINX configuration from Handlebars templates  

Only in *development mode* (`npm run dev`) does the project start a local Express server
to preview the HTML templates.

## How to improve the frontend?

Before starting, ensure you have Node.js (>= 20.x) installed. Then run:

```bash
# Clone the repository
git clone https://github.com/versatiles-org/download.versatiles.org.git
cd download.versatiles.org

# Install dependencies
npm install

# Run the development server
npm run dev
```

Now you can edit [`template/index.html`](https://github.com/versatiles-org/download.versatiles.org/blob/main/template/index.html) and reload the page (`http://localhost:8080`) in your browser.

## Architecture

The system consists of three cooperating parts:

**1. Remote storage (sshfs mount)**
- Contains the authoritative `.versatiles` files.
- The updater scans this directory recursively.
- Missing `.md5` / `.sha256` hashes are computed remotely via SSH.

**2. Update pipeline (Node.js)**  
Defined in [`src/lib/run.ts`](src/lib/run.ts).  
It performs the following steps:

1. Discover all remote `.versatiles` files  
2. Generate or load MD5/SHA256 hashes  
3. Group files into logical datasets (`FileGroup`)  
4. Mirror "local" files into the fast SSD storage  
5. Generate:
   - `index.html` (Handlebars template)
   - `feed-<slug>.xml` (RSS feeds)
6. Collect all public files + synthetic responses (checksum files, URL lists)  
7. Render the final NGINX configuration  

**3. Serving layer (Docker + NGINX)**
- NGINX serves:
  - all public `.versatiles` files  
  - the generated HTML and RSS feeds  
  - synthetic responses such as `urllist_<slug>.tsv`  
- The configuration itself is generated by Node.js from a Handlebars template.
- A webhook (`/update`) triggers the pipeline to rebuild the site.

The `scripts/run.sh` script runs the updater and supervises NGINX using Docker Compose.

## Available Scripts

Here are some of the most commonly used scripts:

- **`npm run check`**: Runs both linting and testing.
- **`npm run dev`**: Starts the development server.
- **`npm run lint`**: Checks the codebase for linting errors using ESLint.
- **`npm run once`**: Runs a one-time script (`run_once.ts`).
- **`npm run server`**: Starts the server.
- **`npm run test`**: Runs tests using Jest.
- **`npm run test-coverage`**: Runs tests and generates a coverage report.
- **`npm run upgrade`**: Updates dependencies.

## Running Tests

The project uses **Vitest** for unit tests.

Run the full test suite:
```bash
npm test
```

With coverage:
```bash
npm run test-coverage
```

## Code Structure Overview

- **`src/lib/file/`**  
  Core domain types: `FileRef`, `FileGroup`, hash generation, sync logic.

- **`src/lib/template/`**  
  HTML + RSS rendering using Handlebars.

- **`src/lib/nginx/`**  
  Builds the final NGINX configuration.

- **`src/lib/run.ts`**  
  The orchestrator for the entire update pipeline.

- **`src/server.ts`**  
  Minimal webhook server for triggering updates.

- **`src/dev.ts`**  
  Development server that renders templates with dummy data.

- **`template/`**  
  Handlebars templates for HTML, RSS, and NGINX.

- **`volumes/` (runtime)**  
  Expected directory structure:
    - `remote_files/`
    - `local_files/`
    - `nginx_conf/`

## Contributing

Contributions are welcome! Please submit a pull request or open an issue for any improvements or bugs you find.

## Deployment Notes

- The updater requires the environment variable `DOMAIN` to construct public URLs.
- Remote hash generation requires:
  - `STORAGE_URL` (SSH target)
  - `.ssh/storage` key inside the container
- The update step must run inside the container so paths match NGINX expectations.

## License

This project is licensed under the MIT License.
